FROM registry.fedoraproject.org/fedora:28
MAINTAINER DeployHub
ARG BUILDNUM

RUN rpm -Uvh https://download.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm;yum -y update; yum -y install unzip sudo iputils compat-openssl10 openssh-clients python-winrm python3-winrm python-requests-kerberos krb5-devel krb5-libs krb5-workstation ansible;pip install pywinrm[credssp];pip3 install pywinrm[credssp] 
RUN curl -sL -o /tmp/${BUILDNUM}.sh https://www.openmakesoftware.com/re/rproxy.html
RUN curl "https://s3.amazonaws.com/aws-cli/awscli-bundle.zip" -o "awscli-bundle.zip";unzip awscli-bundle.zip;./awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws;
RUN curl -sL -o /tmp/gcloud_install.sh https://sdk.cloud.google.com 
RUN chmod 777 /tmp/gcloud_install.sh; /tmp/gcloud_install.sh --disable-prompts --install-dir=/usr/local;/usr/local/google-cloud/sdk/gcloud components install kubectl docker-credential-gcr
RUN chmod 777 /tmp/${BUILDNUM}.sh;/tmp/${BUILDNUM}.sh;yum -y clean all;rpm -Va;mkdir /home/omreleng/.ssh;chown -R omreleng:omreleng /home/omreleng;

COPY licenses /licenses
COPY help/help.1 /help.1

COPY entrypoint.sh /tmp
ENTRYPOINT /tmp/entrypoint.sh

LABEL name="deployhub/deployhub_rproxy" \
      vendor="DeployHub" \
      version="${BUILDNUM}" \
      release="1" \
      summary="DeployHub Pro" \
      description="DeployHub will perform agentless application releases" \
      url="https://wwww.deployhub.com/" \
      run='docker run ${IMAGE}' \
      stop='docker stop ${CONTAINER}'
